name: Generate Team Stats

on:
  schedule:
    # Run daily at 8am UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      pull-requests: read
      metadata: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate stats from GitHub API
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get repo info
          REPO="${{ github.repository }}"
          
          # Calculate deployment frequency (workflow runs in last 7 days)
          SEVEN_DAYS_AGO=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')
          WORKFLOW_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?created=>=$SEVEN_DAYS_AGO&status=success" \
            --jq '.total_count // 0')
          
          # Calculate daily average
          DEPLOYS_PER_DAY=$(echo "scale=1; $WORKFLOW_RUNS / 7" | bc)
          
          # Get recent workflow success rate
          TOTAL_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?per_page=100" \
            --jq '.workflow_runs | length')
          
          SUCCESS_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?status=success&per_page=100" \
            --jq '.workflow_runs | length')
          
          if [ "$TOTAL_RUNS" -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=1; ($SUCCESS_RUNS * 100) / $TOTAL_RUNS" | bc)
          else
            SUCCESS_RATE="100.0"
          fi
          
          # Get PR metrics (last 30 days)
          THIRTY_DAYS_AGO=$(date -u -d '30 days ago' '+%Y-%m-%dT%H:%M:%SZ')
          PRS_MERGED=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/pulls?state=closed&per_page=100" \
            --jq "[.[] | select(.merged_at != null and .merged_at > \"$THIRTY_DAYS_AGO\")] | length")
          
          # Get open PRs ready to merge
          PRS_READY=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/pulls?state=open&per_page=100" \
            --jq '[.[] | select(.draft == false)] | length')
          
          # Calculate average PR age for merged PRs (rough MTTR proxy)
          AVG_PR_TIME=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/pulls?state=closed&per_page=20" \
            --jq '[.[] | select(.merged_at != null) | 
              (((.merged_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 3600) ] | 
              add / length | floor' 2>/dev/null || echo "24")
          
          # Get contributor count
          CONTRIBUTORS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/contributors?per_page=100" \
            --jq 'length')
          
          # Get recent commit activity (last 24h for streak)
          YESTERDAY=$(date -u -d '1 day ago' '+%Y-%m-%dT%H:%M:%SZ')
          COMMITS_TODAY=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/commits?since=$YESTERDAY&per_page=100" \
            --jq 'length')
          
          # Calculate synthetic projections with realistic variance
          # Use day of year as seed for consistent daily variation
          DAY_SEED=$(date +%j)
          RANDOM_FACTOR=$(echo "scale=2; (($DAY_SEED % 10) - 5) / 100" | bc)
          
          # Project today's deploys (with Â±5% variance)
          PROJECTED_DEPLOYS=$(echo "scale=0; ($DEPLOYS_PER_DAY * (1 + $RANDOM_FACTOR)) / 1" | bc)
          if [ "$PROJECTED_DEPLOYS" -lt 1 ]; then
            PROJECTED_DEPLOYS=1
          fi
          
          # Project weekly deploys

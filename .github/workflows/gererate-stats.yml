name: Generate Team Stats

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate stats from GitHub API
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get repo info
          REPO="${{ github.repository }}"
          
          # Calculate deployment frequency (workflow runs in last 7 days)
          SEVEN_DAYS_AGO=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')
          WORKFLOW_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?created=>=$SEVEN_DAYS_AGO&status=success" \
            --jq '.total_count // 0')
          
          # Calculate daily average
          DEPLOYS_PER_DAY=$(echo "scale=0; $WORKFLOW_RUNS / 7" | bc)
          
          # Get recent workflow success rate
          TOTAL_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?per_page=100" \
            --jq '.workflow_runs | length')
          
          SUCCESS_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/actions/runs?status=success&per_page=100" \
            --jq '.workflow_runs | length')
          
          if [ "$TOTAL_RUNS" -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=1; ($SUCCESS_RUNS * 100) / $TOTAL_RUNS" | bc)
          else
            SUCCESS_RATE="100.0"
          fi
          
          # Get PR metrics (last 30 days)
          THIRTY_DAYS_AGO=$(date -u -d '30 days ago' '+%Y-%m-%dT%H:%M:%SZ')
          PRS_MERGED=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/pulls?state=closed&per_page=100" \
            --jq "[.[] | select(.merged_at != null and .merged_at > \"$THIRTY_DAYS_AGO\")] | length")
          
          # Calculate average PR age for merged PRs (rough MTTR proxy)
          AVG_PR_TIME=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/pulls?state=closed&per_page=20" \
            --jq '[.[] | select(.merged_at != null) | 
              (((.merged_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 3600) ] | 
              add / length | floor' 2>/dev/null || echo "24")
          
          # Get contributor count
          CONTRIBUTORS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/contributors?per_page=100" \
            --jq 'length')
          
          # Generate stats.json
          cat > stats.json <<EOF
          {
            "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "metrics": {
              "uptime": "99.9%",
              "deploys_per_day": $DEPLOYS_PER_DAY,
              "mean_time_to_deploy": "${AVG_PR_TIME}h",
              "success_rate": "${SUCCESS_RATE}%",
              "prs_merged_30d": $PRS_MERGED,
              "active_contributors": $CONTRIBUTORS,
              "nps": 42
            },
            "note": "Some metrics are GitHub repo stats, others (uptime, NPS) are example values"
          }
          EOF
          
          cat stats.json

      - name: Commit stats if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet stats.json; then
            echo "No changes to stats.json"
          else
            git add stats.json
            git commit -m "Update team stats [automated]"
            git push
          fi